name: Release with merge

env:
  NODE_VERSION: 16.10

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name where tag will be created'
        type: string
        required: true
        default: 'develop'
      scriptType:
        description: 'Version script'
        type: choice
        required: true
        default: 'prerelease'
        options:
          - 'prerelease'
          - 'patch'
          - 'prepatch'
          - 'minor'
          - 'preminor'
          - 'major'
          - 'premajor'
      preid:
        description: 'prerelease identifiers'
        type: string
        required: false
        default: 'rc'
      secondBranch:
        description: Create second PR?
        type: string
        required: false

jobs:
  log-sample:
    runs-on: ubuntu-latest
    steps:
      - name: Node setup
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Code checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Increase version
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          npm version ${{ inputs.scriptType }} --preid=${{ inputs.preid }}

      - name: Retrieve version
        id: version
        run: |
          echo "TAG_NAME=$(git describe --tags $(git rev-list --tags --max-count=1))" >> $GITHUB_OUTPUT

      - name: Push
        run: |
          git push
          git push origin ${{ steps.version.outputs.TAG_NAME }}

      - name: Merge to ${{ inputs.secondBranch }}
        if: inputs.secondBranch != ''
        run: |
            git fetch origin ${{ inputs.secondBranch }}
            git branch --show-current
            git checkout ${{ inputs.secondBranch }}
            git branch --show-current
            git merge ${{ inputs.branch }}
            git push

